Imports System.IO.Ports
Imports Microsoft.VisualBasic.Devices

Public Class Form1
    Private serialPort As SerialPort
    Private cpuCounter As PerformanceCounter

    Private Sub Form1_Load(sender As Object, e As EventArgs) Handles MyBase.Load
        Me.Text = "114 學年度工業類科學生技藝競賽電腦修護職種第二站崗位號碼：01"

        LoadComPorts()

        If cmbComPort.Items.Count > 0 Then
            cmbComPort.SelectedIndex = 0
        End If

        cmbMode.SelectedIndex = 0

        ' 初始化 CPU 計數器
        Try
            cpuCounter = New PerformanceCounter("Processor", "% Processor Time", "_Total")
            cpuCounter.NextValue()
        Catch ex As Exception
            cpuCounter = Nothing
        End Try

        ' 顯示初始系統資訊
        UpdateSystemInfo()

        ' 啟動計時器
        timerUpdate.Start()

        ' 使用計時器延遲啟動串口，避免 Form 載入時阻塞
        Dim startupTimer As New Timer()
        startupTimer.Interval = 500
        AddHandler startupTimer.Tick, Sub(s, args)
                                          startupTimer.Stop()
                                          AutoOpenPortAndSendLedOpen()
                                      End Sub
        startupTimer.Start()
    End Sub

    Private Sub AutoOpenPortAndSendLedOpen()
        Try
            If cmbComPort.Items.Count > 0 Then
                serialPort = New SerialPort()
                serialPort.PortName = cmbComPort.SelectedItem.ToString()
                serialPort.BaudRate = 9600
                serialPort.DataBits = 8
                serialPort.Parity = Parity.None
                serialPort.StopBits = StopBits.One

                serialPort.Open()

                lblDeviceStatusValue.Text = "Device Online"
                lblDeviceStatusValue.BackColor = Color.LimeGreen

                ' 等待串口穩定
                Threading.Thread.Sleep(100)

                ' 發送 LED_OPEN 命令
                serialPort.WriteLine("LED_OPEN")

                MessageBox.Show("串口已自動開啟並發送 LED_OPEN 命令", "初始化成功", MessageBoxButtons.OK, MessageBoxIcon.Information)
            End If
        Catch ex As Exception
            MessageBox.Show("自動開啟串口失敗：" & ex.Message, "錯誤", MessageBoxButtons.OK, MessageBoxIcon.Error)
            lblDeviceStatusValue.Text = "Device Offline"
            lblDeviceStatusValue.BackColor = Color.Red
        End Try
    End Sub

    Private Sub LoadComPorts()
        cmbComPort.Items.Clear()
        Dim ports() As String = SerialPort.GetPortNames()
        For Each port As String In ports
            cmbComPort.Items.Add(port)
        Next

        If cmbComPort.Items.Count = 0 Then
            cmbComPort.Items.Add("COM3")
        End If
    End Sub

    Private Sub timerUpdate_Tick(sender As Object, e As EventArgs) Handles timerUpdate.Tick
        lblCurrentTime.Text = "Current Time: " & DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss")
        UpdateSystemInfo()
    End Sub

    Private Sub UpdateSystemInfo()
        Try
            ' 使用已初始化的 CPU 計數器
            If cpuCounter IsNot Nothing Then
                Dim cpuUsage As Integer = CInt(cpuCounter.NextValue())
                lblCpuUsage.Text = $"CPU 使用率：{cpuUsage}%"
            Else
                lblCpuUsage.Text = "CPU 使用率：--"
            End If

            Dim ramInfo As New ComputerInfo()
            Dim totalRam As Double = ramInfo.TotalPhysicalMemory / (1024 ^ 3)
            Dim availableRam As Double = ramInfo.AvailablePhysicalMemory / (1024 ^ 3)
            Dim usedRam As Double = totalRam - availableRam
            lblRamUsage.Text = $"RAM 使用率：{usedRam:F1}GB / {totalRam:F1}GB"
        Catch ex As Exception
            lblCpuUsage.Text = "CPU 使用率：--"
            lblRamUsage.Text = "RAM 使用率：-- / --"
        End Try
    End Sub

    Private Sub btnOpen_Click(sender As Object, e As EventArgs) Handles btnOpen.Click
        Try
            If serialPort IsNot Nothing AndAlso serialPort.IsOpen Then
                serialPort.Close()
            End If

            serialPort = New SerialPort()
            serialPort.PortName = cmbComPort.SelectedItem.ToString()
            serialPort.BaudRate = 9600
            serialPort.DataBits = 8
            serialPort.Parity = Parity.None
            serialPort.StopBits = StopBits.One

            serialPort.Open()

            lblDeviceStatusValue.Text = "Device Online"
            lblDeviceStatusValue.BackColor = Color.LimeGreen
            MessageBox.Show("串口已開啟", "成功", MessageBoxButtons.OK, MessageBoxIcon.Information)
        Catch ex As Exception
            MessageBox.Show("無法開啟串口：" & ex.Message, "錯誤", MessageBoxButtons.OK, MessageBoxIcon.Error)
            lblDeviceStatusValue.Text = "Device Offline"
            lblDeviceStatusValue.BackColor = Color.Red
        End Try
    End Sub

    Private Sub btnClose_Click(sender As Object, e As EventArgs) Handles btnClose.Click
        Try
            If serialPort IsNot Nothing AndAlso serialPort.IsOpen Then
                serialPort.Close()
                lblDeviceStatusValue.Text = "Device Offline"
                lblDeviceStatusValue.BackColor = Color.Red
                MessageBox.Show("串口已關閉", "成功", MessageBoxButtons.OK, MessageBoxIcon.Information)
            End If
        Catch ex As Exception
            MessageBox.Show("關閉串口時發生錯誤：" & ex.Message, "錯誤", MessageBoxButtons.OK, MessageBoxIcon.Error)
        End Try
    End Sub

    Private Sub btnTimeSync_Click(sender As Object, e As EventArgs) Handles btnTimeSync.Click
        lblCurrentTime.Text = "Current Time: " & DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss")
        MessageBox.Show("時間已同步", "成功", MessageBoxButtons.OK, MessageBoxIcon.Information)
    End Sub

    Private Sub btnWrite_Click(sender As Object, e As EventArgs) Handles btnWrite.Click
        If serialPort IsNot Nothing AndAlso serialPort.IsOpen Then
            Try
                serialPort.WriteLine("WRITE")
                MessageBox.Show("已發送寫入命令", "成功", MessageBoxButtons.OK, MessageBoxIcon.Information)
            Catch ex As Exception
                MessageBox.Show("寫入失敗：" & ex.Message, "錯誤", MessageBoxButtons.OK, MessageBoxIcon.Error)
            End Try
        Else
            MessageBox.Show("請先開啟串口", "提示", MessageBoxButtons.OK, MessageBoxIcon.Warning)
        End If
    End Sub

    Private Sub btnRead_Click(sender As Object, e As EventArgs) Handles btnRead.Click
        If serialPort IsNot Nothing AndAlso serialPort.IsOpen Then
            Try
                serialPort.WriteLine("READ")
                MessageBox.Show("已發送讀取命令", "成功", MessageBoxButtons.OK, MessageBoxIcon.Information)
            Catch ex As Exception
                MessageBox.Show("讀取失敗：" & ex.Message, "錯誤", MessageBoxButtons.OK, MessageBoxIcon.Error)
            End Try
        Else
            MessageBox.Show("請先開啟串口", "提示", MessageBoxButtons.OK, MessageBoxIcon.Warning)
        End If
    End Sub

    Private Sub cmbMode_SelectedIndexChanged(sender As Object, e As EventArgs) Handles cmbMode.SelectedIndexChanged
        Select Case cmbMode.SelectedIndex
            Case 0
                MessageBox.Show("已選擇：鎖定螢幕", "模式選擇", MessageBoxButtons.OK, MessageBoxIcon.Information)
            Case 1
                MessageBox.Show("已選擇：顯示設置", "模式選擇", MessageBoxButtons.OK, MessageBoxIcon.Information)
            Case 2
                MessageBox.Show("已選擇：電腦資訊", "模式選擇", MessageBoxButtons.OK, MessageBoxIcon.Information)
        End Select
    End Sub

    Private Sub btnExit_Click(sender As Object, e As EventArgs) Handles btnExit.Click
        If MessageBox.Show("確定要退出程式嗎？", "確認", MessageBoxButtons.YesNo, MessageBoxIcon.Question) = DialogResult.Yes Then
            If serialPort IsNot Nothing AndAlso serialPort.IsOpen Then
                serialPort.Close()
            End If
            If cpuCounter IsNot Nothing Then
                cpuCounter.Dispose()
            End If
            Application.Exit()
        End If
    End Sub

    Private Sub Form1_FormClosing(sender As Object, e As FormClosingEventArgs) Handles MyBase.FormClosing
        If serialPort IsNot Nothing AndAlso serialPort.IsOpen Then
            serialPort.Close()
        End If
        If cpuCounter IsNot Nothing Then
            cpuCounter.Dispose()
        End If
    End Sub

End Class
